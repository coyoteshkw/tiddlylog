name: Deploy TiddlyWiki to Pages

on:
  push:
    branches:
      - main

# 权限设置：允许 Actions 修改 Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # --- 核心优化 1：开启内置的 npm 缓存 ---
          cache: "npm"

      - name: Install TiddlyWiki
        # --- 核心优化 2：如果没有 package.json，我们通过特定逻辑安装 ---
        # 如果你仓库里有 package.json，直接用 npm install
        run: |
          if [ -f package.json ]; then
            npm install
          else
            npm install -g tiddlywiki
          fi

      - name: Build Static Site and Sitemap
        run: |
          mkdir -p output

          # 1. 生成首页和静态文章
          npx tiddlywiki main-wiki --output output --build index
          npx tiddlywiki main-wiki --output output --build static

          # 2. 【核心修复】将 static 目录下编码的文件名还原为中文
          # 使用 Python 进行快速重命名，解决 404 问题
          python3 -c "import os, urllib.parse; path='output/static'; [os.rename(os.path.join(path, f), os.path.join(path, urllib.parse.unquote(f))) for f in os.listdir(path) if '%' in f]"

          # 3. 【核心修复】添加 .nojekyll 文件，防止 GitHub 拦截
          touch output/.nojekyll

          # 4. 生成 Sitemap
          SITE_URL="https://coyoteshkw.github.io/tiddlylog"
          echo '<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' > output/sitemap.xml
          for file in output/static/*.html; do
            filename=$(basename "$file")
            if [[ "$filename" == *.html ]]; then
              # 在站点地图里，我们需要保留 URL 编码
              encoded_name=$(echo "$filename" | sed 's/ /%20/g')
              echo "  <url><loc>${SITE_URL}/static/${encoded_name}</loc></url>" >> output/sitemap.xml
            fi
          done
          echo '</urlset>' >> output/sitemap.xml

      - name: Debug Output Structure
        run: |
          ls -R output

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # --- 核心：确保这里也是 output ---
          path: "output"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
