name: Deploy TiddlyWiki to Pages

on:
  push:
    branches:
      - main

# 权限设置：允许 Actions 修改 Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # --- 核心优化 1：开启内置的 npm 缓存 ---
          cache: "npm"

      - name: Install TiddlyWiki
        # --- 核心优化 2：如果没有 package.json，我们通过特定逻辑安装 ---
        # 如果你仓库里有 package.json，直接用 npm install
        run: |
          if [ -f package.json ]; then
            npm install
          else
            npm install -g tiddlywiki
          fi

      - name: Build Static Site and Sitemap
        run: |
          # 1. 准备最终的输出目录
          mkdir -p output/static

          # 2. 生成主 HTML (使用 --output 参数指定位置)
          # 注意：--output 必须放在 --render 之前
          npx tiddlywiki main-wiki --output output --render "$:/core/save/all" "index.html" "text/plain"

          # 3. 生成静态各个文章页
          # 同样使用 --output 参数，并指定到 static 子目录
          npx tiddlywiki main-wiki --output output/static --render "[!is[system]!is[shadow]]" "[title].html" "text/plain" "$:/core/templates/static.tiddler.html"

          # 4. 生成 Sitemap (这一步保持不变，但路径现在更整洁了)
          SITE_URL="https://coyoteshkw.github.io/tiddlylog"
          echo '<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' > output/sitemap.xml

          # 遍历刚刚生成在 output/static 里的文件
          for file in output/static/*.html; do
            filename=$(basename "$file")
            # 排除掉可能存在的 index.html (防止重复)
            if [ "$filename" != "index.html" ]; then
              encoded_name=$(echo "$filename" | sed 's/ /%20/g')
              echo "  <url><loc>${SITE_URL}/static/${encoded_name}</loc></url>" >> output/sitemap.xml
            fi
          done
          echo '</urlset>' >> output/sitemap.xml

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "output"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
