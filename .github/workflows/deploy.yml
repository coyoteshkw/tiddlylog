name: Deploy TiddlyWiki to Pages

on:
  push:
    branches:
      - main

# 权限设置：允许 Actions 修改 Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # --- 核心优化 1：开启内置的 npm 缓存 ---
          cache: "npm"

      - name: Install TiddlyWiki
        # --- 核心优化 2：如果没有 package.json，我们通过特定逻辑安装 ---
        # 如果你仓库里有 package.json，直接用 npm install
        run: |
          if [ -f package.json ]; then
            npm install
          else
            npm install -g tiddlywiki
          fi

      - name: Build Static Site and Sitemap
        run: |
          # 1. 明确创建一个名为 output 的目录
          mkdir -p output

          # 2. 生成主 index.html
          # 注意：--output 后面直接跟 output，它会在仓库根目录下创建该文件夹
          npx tiddlywiki main-wiki --output output --build index

          # 3. 生成每个 Tiddler 的独立静态 HTML (直接放在 output 根目录)
          npx tiddlywiki main-wiki --output output --render "[!is[system]!is[shadow]]" "[title].html" "text/plain" "$:/core/templates/static.tiddler.html"

          # 4. 生成 Sitemap
          SITE_URL="https://coyoteshkw.github.io/tiddlylog"
          echo '<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' > output/sitemap.xml
          for file in output/*.html; do
            filename=$(basename "$file")
            if [ "$filename" != "index.html" ]; then
              encoded_name=$(echo "$filename" | sed 's/ /%20/g')
              echo "  <url><loc>${SITE_URL}/${encoded_name}</loc></url>" >> output/sitemap.xml
            fi
          done
          echo '</urlset>' >> output/sitemap.xml

      - name: Debug Output Structure
        run: |
          echo "--- 检查 output 目录下的所有文件 ---"
          ls -R output

      - name: Deploy to GitHub Pages
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # --- 核心：确保这里也是 output ---
          path: "output"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
