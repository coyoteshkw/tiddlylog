name: Deploy TiddlyWiki to Pages

on:
  push:
    branches:
      - main

# 权限设置：允许 Actions 修改 Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          # --- 核心优化 1：开启内置的 npm 缓存 ---
          cache: "npm"

      - name: Install TiddlyWiki
        # --- 核心优化 2：如果没有 package.json，我们通过特定逻辑安装 ---
        # 如果你仓库里有 package.json，直接用 npm install
        run: |
          if [ -f package.json ]; then
            npm install
          else
            npm install -g tiddlywiki
          fi

      - name: Build Static Site and Sitemap
        run: |
          # 1. 创建一个干净的输出目录
          mkdir -p dist

          # 2. 生成主 index.html (利用你发现的 build 命令)
          # 注意：--output 参数强制让它输出到我们准备好的 dist 文件夹
          npx tiddlywiki main-wiki --output ../dist --build index

          # 3. 生成每个 Tiddler 的独立静态 HTML (直接放在 dist 根目录，网址更短)
          # 我们把它们直接跟 index.html 放在一起，避免多一层 /static/ 路径
          npx tiddlywiki main-wiki --output ../dist --render "[!is[system]!is[shadow]]" "[title].html" "text/plain" "$:/core/templates/static.tiddler.html"

          # 4. 生成 Sitemap
          SITE_URL="https://coyoteshkw.github.io/tiddlylog"
          echo '<?xml version="1.0" encoding="UTF-8"?><urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' > dist/sitemap.xml
          for file in dist/*.html; do
            filename=$(basename "$file")
            if [ "$filename" != "index.html" ]; then
              encoded_name=$(echo "$filename" | sed 's/ /%20/g')
              echo "  <url><loc>${SITE_URL}/${encoded_name}</loc></url>" >> dist/sitemap.xml
            fi
          done
          echo '</urlset>' >> dist/sitemap.xml

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "dist" # <-- 确保上传的是我们新建的这个 dist 文件夹

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "output"

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
